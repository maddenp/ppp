# gfortran pre 4.2 does not support F03 allocatable derived-type components.
# Facts: 4.1.2 does NOT support them, and 4.4.6 does. In-between versions have
# not been tested. Set 'FC' appropriately. See http://bit.ly/N6I39Y for more
# information.

BIN=a.out
EXT=$(suffix $(TEST))
FC=gfortran44
FFLAGS=-w
PPP=../../ppp
STEM=$(basename $(TEST))
TARGETS=bin clean control translation
TEST=$(wildcard t.f t.f90)
TMPFILE=tmpfile
TRANSLATION=$(STEM)_ppp$(EXT)

.PHONY: control

default:
	$(error Valid targets are: $(TARGETS))

bin: $(BIN)

clean:
	$(RM) $(BIN) $(TMPFILE) $(TRANSLATION) *.mod *.sms

control: $(TEST)
ifdef MAKE_CONTROL_DISABLED
	$(info Auto-generation of 'control' is disabled for test $(TEST), investigate...)
else
	$(FC) $(FFLAGS) $(INCFLAG) $^ && a.out >control 2>&1 && $(RM) a.out
endif

translation: $(TRANSLATION)

$(BIN): $(TRANSLATION)
	$(FC) $(FFLAGS) $(TRANSLATION)

$(TRANSLATION): $(TEST)
	$(PPP) $(INCFLAG) $(TEST) > $(TRANSLATION)
