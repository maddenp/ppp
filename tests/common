# gfortran pre 4.2 does not support F03 allocatable derived-type components.
# Facts: 4.1.2 does NOT support them, and 4.4.6 does. In-between versions have
# not been tested. Set 'FC' appropriately. See http://bit.ly/N6I39Y for more
# information.

ifndef ENV
ENV=true
endif
EXE_NEW=exe.new
EXE_OLD=exe.old
FC=gfortran
ifdef INCDIRS
INCFLAG=-I $(INCDIRS)
endif
OBJ_NEW=$(STEM)_ppp.o
OBJ_OLD=$(STEM).o
OUT_NEW=out.new
OUT_OLD=out.old
PPP=../../ppp
PPPC=../../pppc
ifeq ($(TEST),t.f)
PPPFLAGS+= fixed
endif
STEM=$(basename $(TEST))
TARGETS=clean comp $(EXE_NEW) $(EXE_OLD) $(OUT_NEW) $(OUT_OLD) translation
TEST=$(wildcard t.f t.f90)
TMPFILE=tmpfile
TOCLEAN=$(OUT_NEW) $(EXE_NEW) $(EXE_OLD) $(OUT_NEW) $(TMPFILE) $(TRANSLATION) a.out *.env *.mod *.o
TRANSLATION=$(STEM)_ppp.f90

%.o: %.f90
	$(FC) $(FFLAGS) $(INCFLAG) -c $^

.PHONY: $(TARGETS)

default:
	$(error Valid targets are: $(TARGETS))

clean:
ifdef STATIC_OUT_OLD
	$(RM) $(TOCLEAN)
else
	$(RM) $(TOCLEAN) $(OUT_OLD)
endif

comp: $(OUT_OLD) $(OUT_NEW)
	diff $(OUT_OLD) $(OUT_NEW)

translation: $(TRANSLATION)

$(EXE_NEW): $(EXTRA_OBJS) $(OBJ_NEW)
	$(FC) -w $(FFLAGS) $(OBJ_NEW) $(EXTRA_OBJS) $(LIBS) -o $(EXE_NEW)

$(EXE_OLD): $(EXTRA_OBJS) $(OBJ_OLD)
	$(FC) -w $(FFLAGS) $(OBJ_OLD) $(EXTRA_OBJS) $(LIBS) -o $(EXE_OLD)

$(OBJ_NEW): $(TRANSLATION)
	$(FC) -w $(FFLAGS) $(INCFLAG) -c $(TRANSLATION)

$(OBJ_OLD): $(TEST)
	$(FC) -w $(FFLAGS) $(INCFLAG) -c $(TEST)

$(OUT_NEW): $(EXE_NEW)
	$(ENV) && ./$(EXE_NEW) >$(OUT_NEW)

$(OUT_OLD): $(EXE_OLD)
ifndef STATIC_OUT_OLD
	$(ENV) && ./$(EXE_OLD) >$(OUT_OLD)
endif

$(TRANSLATION): $(TEST)
ifdef SOCKET
	$(PPPC) $(SOCKET) $(CURDIR)/$(TEST) $(INCDIRS) > $(TRANSLATION)
else
	$(PPP) $(PPPFLAGS) $(INCFLAG) $(TEST) > $(TRANSLATION)
endif
