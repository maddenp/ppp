# gfortran pre 4.2 does not support F03 allocatable derived-type components.
# Facts: 4.1.2 does NOT support them, and 4.4.6 does. In-between versions have
# not been tested. Set 'FC' appropriately. See http://bit.ly/N6I39Y for more
# information.

EXE=a.out
EXT=$(suffix $(TEST))
FC=gfortran
FFLAGS=-w
INCFLAG=
OBJ=$(STEM)_ppp.o
PPP=../../ppp
PPPC=../../pppc
STEM=$(basename $(TEST))
TARGETS=clean control exe obj translation
TEST=$(wildcard t.f t.f90)
TMPFILE=tmpfile
TRANSLATION=$(STEM)_ppp$(EXT)

ifdef INCDIRS
INCFLAG=-I $(INCDIRS)
endif

.PHONY: control

default:
	$(error Valid targets are: $(TARGETS))

clean:
	$(RM) $(EXE) $(TMPFILE) $(TRANSLATION) *.env *.mod *.o

control: $(TEST)
ifdef DISABLE_CONTROL
	$(info Generation of 'control' is disabled for this test.)
else
	$(FC) $(FFLAGS) $(INCFLAG) $^ && a.out >control 2>&1 && $(RM) a.out
endif

exe: $(EXE)

obj: $(OBJ)

translation: $(TRANSLATION)

$(EXE): $(OBJ)
ifndef DISABLE_EXE
	$(FC) $(FFLAGS) $(OBJ)
endif

$(OBJ): $(TRANSLATION)
	$(FC) $(FFLAGS) -c $(TRANSLATION)

$(TRANSLATION): $(TEST)
ifdef SOCKET
	$(PPPC) $(SOCKET) $(CURDIR)/$(TEST) $(INCDIRS) > $(TRANSLATION)
else
	$(PPP) $(INCFLAG) $(TEST) > $(TRANSLATION)
endif
